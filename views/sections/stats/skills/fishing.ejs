<% 
// NOTE: importing itemIcon seems to not work
function itemIcon(item, classes) {
  %>
<div <% if (item.texture_path) { %> style='background-image: url("<%= item.texture_path %>")' <% } %> class="
      <%= classes.join(" ") %>
      item-icon
      <% if (isEnchanted(item)) { %>is-enchanted <% } %>
      <% if (item.texture_path) { %>custom-icon<% } %>
      <% if (item.Damage != 0) { %>icon-<%= item.id %>_0<% } %>
      icon-<%= item.id %>_<%= item.Damage %>
    ">
</div>
<%
}

function isEnchanted(item) {
  // heads
  if ([397].includes(item.id)) {
    return false;
  }

  // enchanted book, bottle o' enchanting, nether star
  if ([403, 384, 399].includes(item.id)) {
    return true;
  }

  // potions potions with actual effects (not water bottles)
  if (item.id === 373 && item.Damage !== 0) {
    return true;
  }

  if ("tag" in item && Array.isArray(item.tag.ench)) {
    return true;
  }

  if (item.glowing) {
    return true;
  }

  return false;
}

const seaCreatures = [
  "pond_squid",
  "sea_walker",
  "night_squid",
  "frozen_steve",
  "nurse_shark",
  "sea_guardian",
  "frosty_the_snowman",
  "sea_witch",
  "scarecrow",
  "sea_archer",
  "oasis_rabbit",
  "oasis_sheep",
  "blue_shark",
  "monster_of_the_deep",
  "grinch",
  "catfish",
  "nightmare",
  "carrot_king",
  "water_worm",
  "sea_leech",
  "poisoned_water_worm",
  "flaming_worm",
  "werewolf",
  "guardian_defender",
  "deep_sea_protector",
  "lava_blaze",
  "lava_pigman",
  "tiger_shark",
  "water_hydra",
  "sea_emperor",
  "phantom_fisherman",
  "zombie_miner",
  "great_white_shark",
  "yeti",
  "grim_reaper",
];

let totalSeaCreatureKills = 0;
calculated.kills.map((kill) => {
  if (seaCreatures.includes(kill.entityId)) totalSeaCreatureKills += kill.count; 
})
%>

<p class="stat-raw-values">
  <span class="stat-name">Items fished: </span><span class="stat-value"><%= calculated.fishing.total.toLocaleString() %></span><br>
  <span class="stat-name">Treasures fished: </span><span class="stat-value"><%= calculated.fishing.treasure.toLocaleString() %></span><br>
  <span class="stat-name">Large treasures fished: </span><span class="stat-value"><%= calculated.fishing.treasure_large.toLocaleString() %></span><br>
  <span class="stat-name">Sea Creatures killed: </span><span class="stat-value"><%= totalSeaCreatureKills.toLocaleString() %></span><br>
  <% if (calculated.fishing.shredder_fished > 0 && calculated.fishing.shredder_bait > 0) { %>
  <span data-tippy-content='<span class="stat-name">Fished with Shredder: </span><span class="stat-value"><%= calculated.fishing.shredder_fished.toLocaleString() %></span><br><span class="stat-name">Bait used with Shredder: </span><span class="stat-value"><%= calculated.fishing.shredder_bait.toLocaleString() %></span><br>'>
    <span class="stat-name">Fished with Shredder: </span><span class="stat-value"><%= calculated.fishing.shredder_fished.toLocaleString() %></span></span><br>
  <% } %>
</p>

<% if (items.fishing_tools.length > 0) { %>
<p class="stat-sub-header">Fishing Rods</p>
<% if (items.highest_rarity_fishing_tool) { %>
<p class="stat-raw-values">
  <span class="stat-name">Active Rod: </span>
  <span class="stat-active-rod stat-value"><%- helper.renderLore(items.highest_rarity_fishing_tool.tag.display.Name) %></span>
</p>
<% }else if (items.fishing_tools.length > 0) { %>
<p class="stat-raw-values">
  <span class="stat-name">Active Rod: </span><span class="stat-active-rod stat-value piece-common-fg">None</span>
</p>
<% } %>
<div class="pieces">
  <%
        items.fishing_tools.filter(a => !a.hidden).forEach(item => { %>
  <div tabindex="0" data-item-id="<%= item.itemId %>" class="rich-item piece piece-<%= item.rarity %>-bg <%= getRarityUpgradeClass(item) %>">
    <% if (rarityOrder.indexOf(item.rarity) <= 4) { %>
    <div class="piece-shine"></div>
    <% } %>

    <% itemIcon(item, ['piece-icon']); %>
  </div>
  <%});%>
</div>
<% } %>

<% if (totalSeaCreatureKills > 0) { %>
<button class="stat-sub-header extender" aria-controls="missing-seacreatures" aria-expanded="false">Sea Creatures</button>
<div class="sea-creatures extendable" id="missing-seacreatures">
  <% for(const creatureId of seaCreatures) {
        const creature = calculated.kills.find(creature => creature.entityId == creatureId);

        if (creature?.amount > 0) {%>
  <div class="sea-creature">
    <div class="sea-creature-name"><span><%= creature.entityName %></span></div>
    <div class="sea-creature-image" style="background-image: url(/resources/img/sea_creatures/<%= creature.entityId %>.webp)"></div>
    <div class="sea-creature-kills"><span class="stat-value"><%= creature.amount.toLocaleString() %></span><span class="stat-name"> Kill<%= creature.amount != 1 ? 's' : '' %></span></div>
  </div>
  <% } %>
  <% } %>
</div>
<% } %>